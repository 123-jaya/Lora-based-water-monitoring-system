#include <HardwareSerial.h>

HardwareSerial LoRaSerial(2);

// ONE LED â€” MOTOR INDICATOR
#define MOTOR_LED 4

// Track latest states
bool tankEmpty = false;   // true => BELOW 15 cm zone (E)
bool sumpFull  = false;   // true => SF

void setup() {
  Serial.begin(115200);

  pinMode(MOTOR_LED, OUTPUT);
  digitalWrite(MOTOR_LED, LOW);

  // LoRa receiver baud
  LoRaSerial.begin(115200, SERIAL_8N1, 16, 17);

  LoRaSerial.println("AT+ADDRESS=3");   // RX address
  LoRaSerial.println("AT+NETWORKID=5");
  LoRaSerial.println("AT+BAND=865000000");

  Serial.println("Receiver Ready (Single LED Mode)");
}

void loop() {

  if (LoRaSerial.available()) {

    String s = LoRaSerial.readStringUntil('\n');
    s.trim();
    Serial.println("RAW: " + s);

    if (!s.startsWith("+RCV="))
      return;

    int c1 = s.indexOf(',');
    int c2 = s.indexOf(',', c1 + 1);
    int c3 = s.indexOf(',', c2 + 1);
    if (c1 == -1 || c2 == -1 || c3 == -1) return;

    int eq = s.indexOf('=');
    int sender = s.substring(eq + 1, c1).toInt();

    String msg = s.substring(c2 + 1, c3);
    msg.trim();

    Serial.print("Sender: ");
    Serial.println(sender);
    Serial.print("Message: ");
    Serial.println(msg);

    // --------- Update statuses from each TX ---------

    if (sender == 1) {     // TANK TX1: E / F / O
      Serial.println("From TANK TX1");

      // E  => tank BELOW 20 cm zone (needs filling)
      // F/O => tank has reached 20 cm or above (enough water)
      if (msg == "E") {
        tankEmpty = true;          // below 20 cm
      } else {
        tankEmpty = false;         // 20 cm or higher
      }
    }
    else if (sender == 2) { // SUMP TX2: SE / SF / SO
      Serial.println("From SUMP TX2");

      // SF => sump full (OK)
      // SE => sump empty (STOP)
      if (msg == "SF") {
        sumpFull = true;
      }
      else if (msg == "SE") {
        sumpFull = false;
      }
      else {
        // SO or other => treat as NOT full (for safety keep motor OFF)
        sumpFull = false;
      }
    }

    // --------- Apply combined motor logic ---------
    // Motor ON  when: tankEmpty (below 20 cm) AND sumpFull
    // Motor OFF when: !tankEmpty (reached 20 cm) OR !sumpFull (sump empty or not full)

    if (tankEmpty && sumpFull) {
      digitalWrite(MOTOR_LED, HIGH);
      Serial.println("MOTOR ON: TANK < 20 cm AND tank FULL");
    } else {
      digitalWrite(MOTOR_LED, LOW);
      Serial.println("MOTOR OFF: Tank >= 20 cm OR tank not full");
    }
  }
}